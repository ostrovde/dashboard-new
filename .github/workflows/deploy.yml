name: üöÄ RayAgro Auto Deploy

on:
  push:
    branches:
      - main

env:
  SYNC_URL: http://95.***.***.***:8081/sync   # —Å—é–¥–∞ –≤—Å—Ç–∞–≤—å –≤–Ω–µ—à–Ω–∏–π IP —Å–µ—Ä–≤–µ—Ä–∞
  DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  TELEGRAM_CHAT_ID: "1396090830"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Lint and Build
        run: |
          npm run lint || echo "‚ö†Ô∏è Lint warnings, continuing..."
          npm run build

      - name: üöÄ Trigger FastAPI Deploy
        id: sync
        run: |
          echo "Triggering FastAPI sync..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$SYNC_URL" -H "Authorization: Bearer $DEPLOY_TOKEN")
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Deploy success"
            echo "RESULT=success" >> $GITHUB_ENV
          else
            echo "‚ùå Deploy failed, HTTP $RESPONSE"
            echo "RESULT=failure" >> $GITHUB_ENV
          fi

      - name: üí¨ Telegram Notification
        if: always()
        run: |
          if [ "${{ env.RESULT }}" = "success" ]; then
            MSG="‚úÖ *RayAgro Dashboard Updated*\nRepository: *${{ github.repository }}*\nBranch: *${{ github.ref_name }}*\nCommit: *${{ github.sha }}*"
          else
            MSG="‚ùå *RayAgro Deploy Failed!*\nRepository: *${{ github.repository }}*\nBranch: *${{ github.ref_name }}*\nCommit: *${{ github.sha }}*"
          fi

          curl -s -X POST https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ env.TELEGRAM_CHAT_ID }}\", \"text\": \"$MSG\", \"parse_mode\": \"Markdown\"}"
